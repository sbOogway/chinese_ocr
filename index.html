<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Device Camera Demo</title>
    <style>
      video {
        width: 100vw;
        height: 100vh;
      }
      button {
        margin-top: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="module" crossorigin src="/assets/index-D8jpVEFv.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-CzJH_C7E.css">
  </head>
  <body>
    <!-- <h2>Live Camera Feed</h2> -->
    <main class="h-screen w-screen">
      <div
        id="carousel-dots"
        class="flex gap-1 hover:cursor-pointer w-full p-4"
      ></div>
      <div
        id="carousel-container"
        class="flex overflow-x-auto snap-x snap-mandatory"
      >
        <div class="w-full flex-none snap-start flex flex-col">
          <video id="camera" autoplay></video>
          <!-- <canvas id="overlay"></canvas> -->
          <button id="snap" >Take Photo</button>
        </div>

        <div class="w-full flex-none snap-start">
          <button id="start">start camera</button>
          <canvas id="snapshot" style="display: none"></canvas>
          <img id="photo" alt="Captured image" />
          <div id="text">placeholder</div>
        </div>
      </div>
    </main>
    <!-- v5 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>


    <script>
      const video = document.getElementById("camera");
      const snapBtn = document.getElementById("snap");
      const canvas = document.getElementById("snapshot");
      const photo = document.getElementById("photo");
      const start = document.getElementById("start");
      const text = document.getElementById("text");
      const overlay = document.getElementById("overlay");

      const carouselContainer = document.getElementById("carousel-container")

      var photoData;
      var img = new Image();

      // Request access to the camera
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            }, // 'environment' for rear camera on mobile
            audio: false,
          });
          video.srcObject = stream;
        } catch (err) {
          console.error("Error accessing camera:", err);
          alert(err + "Could not access the camera. Please allow permission.");
        }
      }

      // Capture a frame from the video
      async function takePhoto() {
        const worker = await Tesseract.createWorker("chi_tra");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        // Convert to data URL and show the image
        photoData = canvas.toDataURL("image/png");
        photo.src = photoData;

        const ret = await worker.recognize(canvas.toDataURL("image/png"));
        console.log(ret);
        console.log("dbg :: " + ret.data.text);
        text.innerText = ret.data.text;
        // await new Promise((resolve) => setTimeout(resolve, 2000));

        await worker.terminate();

        carouselContainer.children.item(1).scrollIntoView();
      }

      // function drawRect() {
      //   var ctx = overlay.getContext("2d");

      //   overlay.width = video.videoWidth;
      //   overlay.height = video.videoHeight;

      //   ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

      //   var faceArea = 300;
      //   var pX = overlay.width / 2 - faceArea / 2;
      //   var yX = overlay.height / 2 - faceArea / 2;

      //   ctx.rect(pX, pY, faceArea, faceArea);

      //   ctx.linewidth = "6";
      //   ctx.strokeStyle = "red";

      //   ctx.stroke();

      //   setTimeout(drawRect, 100);
      // }

      snapBtn.addEventListener("click", takePhoto);
      start.addEventListener("click", startCamera);

      // video.onplay = function () {
      //   setTimeout(drawImage, 300);
      // };

      start.click();
    </script>
  </body>
</html>
