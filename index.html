<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Device Camera Demo</title>
    <style>
      video {
        width: 100vw;
        height: 100vh;
      }
      button {
        margin-top: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="src/style.css">
    </head>
  <body>
    <!-- <h2>Live Camera Feed</h2> -->
    <div id="carousel-dots" class="flex gap-1 hover:cursor-pointer"></div>
    <div id="carousel-container" class="flex overflow-x-auto snap-x snap-mandatory">
      <div class="w-full flex-none snap-start">
        <video id="camera" autoplay playsinline></video>
      </div>

      <div>
        <button id="snap">Take Photo</button>
        <button id="start">start camera</button>
        <canvas id="snapshot" style="display: none"></canvas>
        <img id="photo" alt="Captured image" />
        <div id="text">placeholder</div>
      </div>
    </div>
    <!-- v5 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script type="module" src="src/main.js"></script>

    <script>
      const video = document.getElementById("camera");
      const snapBtn = document.getElementById("snap");
      const canvas = document.getElementById("snapshot");
      const photo = document.getElementById("photo");
      const start = document.getElementById("start");
      const text = document.getElementById("text");
      var photoData;
      var img = new Image();

      // Request access to the camera
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            }, // 'environment' for rear camera on mobile
            audio: false,
          });
          video.srcObject = stream;
        } catch (err) {
          console.error("Error accessing camera:", err);
          alert(err + "Could not access the camera. Please allow permission.");
        }
      }

      // Capture a frame from the video
      async function takePhoto() {
        const worker = await Tesseract.createWorker("chi_tra");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        // Convert to data URL and show the image
        photoData = canvas.toDataURL("image/png");
        photo.src = photoData;

        const ret = await worker.recognize(canvas.toDataURL("image/png"));
        console.log(ret);
        console.log("dbg :: " + ret.data.text);
        text.innerText = ret.data.text;
        // await new Promise((resolve) => setTimeout(resolve, 2000));

        await worker.terminate();
      }

      snapBtn.addEventListener("click", takePhoto);
      start.addEventListener("click", startCamera);

      start.click();
    </script>
  </body>
</html>
